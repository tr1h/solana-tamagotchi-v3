<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Solana Tamagotchi - Master Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@latest/lib/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ffd700, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #ffd700;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .admin-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .admin-section h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
        }

        .btn-warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            background: rgba(255, 255, 255, 0.1);
            color: #ffd700;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #ffd700;
        }

        .hidden {
            display: none;
        }

        .wallet-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .wallet-info h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .wallet-address {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 5px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Solana Tamagotchi</h1>
            <p>Master Admin Panel - Complete Control</p>
        </div>

        <div id="loading" class="loading">
            <h2>üîê Checking Admin Access...</h2>
        </div>

        <div id="admin-panel" class="hidden">
            <div class="wallet-info">
                <h3>üîó Connected Wallet</h3>
                <div class="wallet-address" id="wallet-address">Not connected</div>
            </div>

            <!-- Treasury Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üè¶ Treasury Balance</h3>
                    <div class="stat-value" id="treasury-balance">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>üë• Total Players</h3>
                    <div class="stat-value" id="total-players">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>üé® NFTs Minted</h3>
                    <div class="stat-value" id="total-nfts">Loading...</div>
                </div>
                <div class="stat-card">
                    <h3>üí∞ Total TAMA</h3>
                    <div class="stat-value" id="total-tama">Loading...</div>
                </div>
            </div>

            <!-- TAMA Operations -->
            <div class="admin-section">
                <h2>üí∞ TAMA Operations</h2>
                <button class="btn btn-success" onclick="addTAMA()">‚ûï Add TAMA</button>
                <button class="btn btn-danger" onclick="removeTAMA()">‚ûñ Remove TAMA</button>
                <button class="btn btn-warning" onclick="setBalance()">üéØ Set Balance</button>
                <button class="btn" onclick="viewTAMAHistory()">üìú View History</button>
            </div>

            <!-- Database Management -->
            <div class="admin-section">
                <h2>üóÑÔ∏è Database Management</h2>
                <button class="btn" onclick="loadAllData()">üîÑ Refresh All Data</button>
                <button class="btn btn-warning" onclick="fixDatabase()">üîß Fix Database</button>
                <button class="btn btn-danger" onclick="clearTestData()">üóëÔ∏è Clear Test Data</button>
            </div>

            <!-- Players Table -->
            <div class="admin-section">
                <h2>üë• All Players</h2>
                <div id="players-table">
                    <div class="loading">Loading players...</div>
                </div>
            </div>

            <!-- NFT Mints Table -->
            <div class="admin-section">
                <h2>üé® NFT Mints</h2>
                <div id="nfts-table">
                    <div class="loading">Loading NFTs...</div>
                </div>
            </div>
        </div>

        <div id="access-denied" class="hidden">
            <div style="text-align: center; padding: 50px;">
                <h2 style="color: #e74c3c; margin-bottom: 20px;">üö´ ACCESS DENIED</h2>
                <p>You are not authorized to access this admin panel.</p>
                <button class="btn" onclick="location.reload()">üîÑ Try Again</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://zfrazyupameidxpjihrh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Admin wallets
        const adminWallets = [
            '8bJixyhkqKJtGDEwrc9xLb2MPpL4yGjDNmiXWhCq86KA',
            'G8vpUg12KQUXkv7JfRxfSxYPUDwW9jtZ8CiL8KB5aXK2',
            'FVqqbyFMDysBjoMUgUDp5fGXhPwR9P82t1mNd4GJmBZK',
            '2eyQycA4d4zu3FbbwdvHuJ1fVDcfQsz78qGdKGYa8NXw'
        ];

        let currentWallet = null;

        // Check admin access
        async function checkAdminAccess() {
            try {
                if (typeof window.solana === 'undefined') {
                    throw new Error('Phantom wallet not found');
                }

                const wallet = window.solana;
                if (!wallet.isConnected) {
                    const resp = await wallet.connect();
                    if (!resp.publicKey) {
                        throw new Error('Failed to connect wallet');
                    }
                }

                currentWallet = wallet.publicKey.toString();
                document.getElementById('wallet-address').textContent = currentWallet;

                if (adminWallets.includes(currentWallet)) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('admin-panel').classList.remove('hidden');
                    loadAllData();
                    return true;
                } else {
                    throw new Error('Access denied');
                }
            } catch (error) {
                console.error('Admin check error:', error);
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('access-denied').classList.remove('hidden');
                return false;
            }
        }

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadTreasuryStats(),
                loadPlayers(),
                loadNFTs()
            ]);
        }

        // Load Treasury stats
        async function loadTreasuryStats() {
            try {
                // Treasury balance from localStorage
                const treasuryBalance = localStorage.getItem('tama_balance_TREASURY_MAIN_ACCOUNT') || '0';
                document.getElementById('treasury-balance').textContent = parseInt(treasuryBalance).toLocaleString() + ' TAMA';

                // Total players
                const { count: playersCount } = await supabase
                    .from('leaderboard')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('total-players').textContent = playersCount || 0;

                // Total NFTs
                const { count: nftsCount } = await supabase
                    .from('nft_mints')
                    .select('*', { count: 'exact', head: true });
                document.getElementById('total-nfts').textContent = nftsCount || 0;

                // Total TAMA in circulation
                const { data: players } = await supabase
                    .from('leaderboard')
                    .select('tama');
                const totalTAMA = players?.reduce((sum, player) => sum + (player.tama || 0), 0) || 0;
                document.getElementById('total-tama').textContent = totalTAMA.toLocaleString() + ' TAMA';

            } catch (error) {
                console.error('Error loading treasury stats:', error);
            }
        }

        // Load players
        async function loadPlayers() {
            try {
                const { data: players, error } = await supabase
                    .from('leaderboard')
                    .select('*')
                    .order('tama', { ascending: false });

                if (error) throw error;

                const table = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Wallet</th>
                                <th>Pet Name</th>
                                <th>Level</th>
                                <th>XP</th>
                                <th>TAMA</th>
                                <th>Type</th>
                                <th>Rarity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${players?.map(player => `
                                <tr>
                                    <td>${player.wallet_address.slice(0, 8)}...</td>
                                    <td>${player.pet_name || 'N/A'}</td>
                                    <td>${player.level || 1}</td>
                                    <td>${player.xp || 0}</td>
                                    <td>${player.tama || 0}</td>
                                    <td>${player.pet_type || 'N/A'}</td>
                                    <td>${player.pet_rarity || 'N/A'}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="7">No players found</td></tr>'}
                        </tbody>
                    </table>
                `;

                document.getElementById('players-table').innerHTML = table;
            } catch (error) {
                console.error('Error loading players:', error);
                document.getElementById('players-table').innerHTML = '<div class="loading">Error loading players</div>';
            }
        }

        // Load NFTs
        async function loadNFTs() {
            try {
                const { data: nfts, error } = await supabase
                    .from('nft_mints')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const table = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Wallet</th>
                                <th>Pet Name</th>
                                <th>Type</th>
                                <th>Rarity</th>
                                <th>Price</th>
                                <th>Minted At</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${nfts?.map(nft => `
                                <tr>
                                    <td>${nft.id}</td>
                                    <td>${nft.wallet_address.slice(0, 8)}...</td>
                                    <td>${nft.pet_name || 'N/A'}</td>
                                    <td>${nft.pet_type || 'N/A'}</td>
                                    <td>${nft.pet_rarity || 'N/A'}</td>
                                    <td>${nft.price || 'N/A'} SOL</td>
                                    <td>${new Date(nft.created_at).toLocaleDateString()}</td>
                                </tr>
                            `).join('') || '<tr><td colspan="7">No NFTs found</td></tr>'}
                        </tbody>
                    </table>
                `;

                document.getElementById('nfts-table').innerHTML = table;
            } catch (error) {
                console.error('Error loading NFTs:', error);
                document.getElementById('nfts-table').innerHTML = '<div class="loading">Error loading NFTs</div>';
            }
        }

        // TAMA Operations
        function addTAMA() {
            const wallet = prompt('Enter wallet address:');
            const amount = prompt('Enter amount:');
            if (wallet && amount) {
                // Implementation here
                alert(`Adding ${amount} TAMA to ${wallet}`);
            }
        }

        function removeTAMA() {
            const wallet = prompt('Enter wallet address:');
            const amount = prompt('Enter amount:');
            if (wallet && amount) {
                // Implementation here
                alert(`Removing ${amount} TAMA from ${wallet}`);
            }
        }

        function setBalance() {
            const wallet = prompt('Enter wallet address:');
            const balance = prompt('Enter new balance:');
            if (wallet && balance) {
                // Implementation here
                alert(`Setting balance to ${balance} TAMA for ${wallet}`);
            }
        }

        function viewTAMAHistory() {
            alert('TAMA History feature coming soon!');
        }

        function fixDatabase() {
            alert('Database fix feature coming soon!');
        }

        function clearTestData() {
            if (confirm('Are you sure you want to clear all test data?')) {
                alert('Clear test data feature coming soon!');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', checkAdminAccess);
    </script>
</body>
</html>
