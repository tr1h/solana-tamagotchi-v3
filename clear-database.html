<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üóëÔ∏è Clear Test Data</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(0,0,0,0.3);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #00ff88;
        }
        h1 {
            text-align: center;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
            margin-bottom: 30px;
        }
        .warning {
            background: rgba(255,0,0,0.2);
            border: 2px solid #ff4444;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }
        .button.safe {
            background: linear-gradient(45deg, #00ff88, #00d4aa);
        }
        .button.safe:hover {
            box-shadow: 0 5px 15px rgba(0,255,136,0.4);
        }
        .info {
            background: rgba(0,255,136,0.1);
            border: 1px solid #00ff88;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .result {
            background: rgba(0,0,0,0.5);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóëÔ∏è DATABASE CLEAR TOOL</h1>
        
        <div class="warning">
            <h3>‚ö†Ô∏è WARNING!</h3>
            <p>This will delete ALL test data from the database!</p>
            <p><strong>Table structure will be preserved.</strong></p>
        </div>

        <div class="info">
            <h3>üìä What will be cleared:</h3>
            <ul>
                <li>All player data (leaderboard)</li>
                <li>All NFT mints</li>
                <li>All transaction history</li>
                <li>All referrals</li>
                <li>All evolution history</li>
                <li>All anti-cheat logs</li>
            </ul>
            <p><strong>‚úÖ Treasury will be reset to 1,000,000,000 TAMA</strong></p>
        </div>

        <div style="text-align: center;">
            <button class="button safe" onclick="quickClear()">
                üöÄ QUICK CLEAR (Recommended)
            </button>
            <button class="button" onclick="fullClear()">
                üóëÔ∏è FULL CLEAR (Everything)
            </button>
        </div>

        <div class="info" style="margin-top: 20px;">
            <h3>üìù Manual Method (If buttons fail):</h3>
            <p>1. Go to <strong>Supabase Dashboard</strong> ‚Üí <strong>SQL Editor</strong></p>
            <p>2. Copy and paste the contents of <code>MANUAL_CLEAR.sql</code></p>
            <p>3. Click <strong>Run</strong></p>
            <p><strong>‚úÖ This method always works!</strong></p>
        </div>

        <div id="result" class="result" style="display: none;"></div>

        <div style="text-align: center; margin-top: 30px;">
            <a href="admin.html" style="color: #00ff88; text-decoration: none;">
                ‚Üê Back to Admin Panel
            </a>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const supabaseUrl = 'https://zfrazyupameidxpjihrh.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpmcmF6eXVwYW1laWR4cGppaHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5Mzc1NTAsImV4cCI6MjA3NTUxMzU1MH0.1EkMDqCNJoAjcJDh3Dd3yPfus-JpdcwE--z2dhjh7wU';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function quickClear() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'üîÑ Clearing data...';

            try {
                // Method 1: Try to get all records first, then delete by ID
                console.log('üîÑ Method 1: Getting all records to delete...');
                
                // Get all transaction IDs
                const { data: txData } = await supabase
                    .from('tama_transactions')
                    .select('id');
                
                if (txData && txData.length > 0) {
                    const txIds = txData.map(tx => tx.id);
                    const { error: txError } = await supabase
                        .from('tama_transactions')
                        .delete()
                        .in('id', txIds);
                    if (txError) throw txError;
                }

                // Get all NFT mint IDs
                const { data: nftData } = await supabase
                    .from('nft_mints')
                    .select('id');
                
                if (nftData && nftData.length > 0) {
                    const nftIds = nftData.map(nft => nft.id);
                    const { error: nftError } = await supabase
                        .from('nft_mints')
                        .delete()
                        .in('id', nftIds);
                    if (nftError) throw nftError;
                }

                // Clear leaderboard (except Treasury)
                const { error: lbError } = await supabase
                    .from('leaderboard')
                    .delete()
                    .neq('wallet_address', 'TREASURY_MAIN_ACCOUNT');

                if (lbError) throw lbError;

                // Reset Treasury balance
                const { error: treasuryError } = await supabase
                    .from('leaderboard')
                    .upsert({
                        wallet_address: 'TREASURY_MAIN_ACCOUNT',
                        pet_name: 'Treasury',
                        level: 1,
                        xp: 0,
                        tama: 1000000000,
                        pet_type: 'Treasury',
                        pet_rarity: 'legendary',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (treasuryError) throw treasuryError;

                resultDiv.textContent = '‚úÖ QUICK CLEAR COMPLETED!\n\n' +
                    '‚Ä¢ Transaction history: CLEARED\n' +
                    '‚Ä¢ Player data: CLEARED\n' +
                    '‚Ä¢ NFT mints: CLEARED\n' +
                    '‚Ä¢ Treasury: RESET to 1,000,000,000 TAMA\n\n' +
                    'üéâ Ready for fresh testing!';

            } catch (error) {
                resultDiv.textContent = '‚ùå ERROR: ' + error.message;
                console.error('Clear error:', error);
            }
        }

        async function fullClear() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL data?\n\nThis includes:\n‚Ä¢ All players\n‚Ä¢ All transactions\n‚Ä¢ All referrals\n‚Ä¢ All logs\n\nThis action cannot be undone!')) {
                return;
            }

            const resultDiv = document.getElementById('result');
            resultDiv.style.display = 'block';
            resultDiv.textContent = 'üîÑ Full clearing...';

            try {
                // Clear all tables
                const tables = [
                    'tama_transactions',
                    'leaderboard',
                    'nft_mints',
                    'referrals',
                    'evolution_history',
                    'ability_usage',
                    'anti_cheat_logs',
                    'banned_users',
                    'player_actions',
                    'price_history'
                ];

                for (const table of tables) {
                    const { error } = await supabase
                        .from(table)
                        .delete()
                        .gte('created_at', '1900-01-01'); // Delete all (using date filter)
                    
                    if (error) {
                        console.warn(`Warning clearing ${table}:`, error);
                        // Continue with other tables even if one fails
                    }
                }

                // Reset Treasury
                const { error: treasuryError } = await supabase
                    .from('leaderboard')
                    .upsert({
                        wallet_address: 'TREASURY_MAIN_ACCOUNT',
                        pet_name: 'Treasury',
                        level: 1,
                        xp: 0,
                        tama: 1000000000,
                        pet_type: 'Treasury',
                        pet_rarity: 'legendary',
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (treasuryError) throw treasuryError;

                // Reset game settings
                const { error: settingsError } = await supabase
                    .from('game_settings')
                    .upsert([
                        { key: 'nft_mint_price', value: '0.01', description: 'NFT mint price in SOL', updated_at: new Date().toISOString() },
                        { key: 'mint_phase', value: 'active', description: 'Current mint phase', updated_at: new Date().toISOString() },
                        { key: 'tama_bonus_multiplier', value: '1.0', description: 'TAMA bonus multiplier', updated_at: new Date().toISOString() }
                    ]);

                if (settingsError) throw settingsError;

                resultDiv.textContent = '‚úÖ FULL CLEAR COMPLETED!\n\n' +
                    '‚Ä¢ All tables: CLEARED\n' +
                    '‚Ä¢ Treasury: RESET to 1,000,000,000 TAMA\n' +
                    '‚Ä¢ Game settings: RESET to defaults\n\n' +
                    'üéâ Database is completely fresh!';

            } catch (error) {
                resultDiv.textContent = '‚ùå ERROR: ' + error.message;
                console.error('Full clear error:', error);
            }
        }
    </script>
</body>
</html>
